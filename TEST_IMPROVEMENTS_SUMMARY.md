# æµ‹è¯•å·¥å…·æ”¹è¿›æ€»ç»“æŠ¥å‘Š

## æ¦‚è¿°

æˆ‘ä»¬å·²ç»æˆåŠŸä¿®å¤äº†ç°æœ‰çš„æµ‹è¯•é—®é¢˜ï¼Œå¹¶æ·»åŠ äº†æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šå’Œæ€§èƒ½åŸºå‡†æµ‹è¯•ç­‰é«˜çº§åŠŸèƒ½ã€‚è¿™äº›æ”¹è¿›æ˜¾è‘—æå‡äº†æµ‹è¯•è´¨é‡å’Œå¼€å‘ä½“éªŒã€‚

## ğŸ”§ å·²ä¿®å¤çš„æµ‹è¯•é—®é¢˜

### 1. **å¼‚æ­¥å‡½æ•°çš„ Mock è®¾ç½®é—®é¢˜**

#### é—®é¢˜æè¿°
- `TypeError: object NoneType can't be used in 'await' expression`
- å¼‚æ­¥å‡½æ•°çš„ Mock å¯¹è±¡æ²¡æœ‰æ­£ç¡®è®¾ç½®è¿”å›å€¼
- æµ‹è¯•ä¸­çš„ `await` è°ƒç”¨å¤±è´¥

#### è§£å†³æ–¹æ¡ˆ
- ä½¿ç”¨ `AsyncMock` æ›¿ä»£æ™®é€šçš„ `MagicMock` æ¥æ¨¡æ‹Ÿå¼‚æ­¥å‡½æ•°
- æ­£ç¡®è®¾ç½®å¼‚æ­¥å‡½æ•°çš„è¿”å›å€¼
- ä¿®å¤äº†æ‰€æœ‰ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹

#### ä¿®å¤çš„æ–‡ä»¶
- `tests/test_rate_limiter.py` - é™é€Ÿç³»ç»Ÿæµ‹è¯•
- `tests/test_alphavantage_adapter.py` - Alpha Vantage é€‚é…å™¨æµ‹è¯•

#### ä¿®å¤ç¤ºä¾‹
```python
# ä¿®å¤å‰
mock_manager.acquire.return_value = None

# ä¿®å¤å
mock_manager.acquire = AsyncMock(return_value=None)
```

### 2. **æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•çš„å¼‚æ­¥è°ƒç”¨é—®é¢˜**

#### é—®é¢˜æè¿°
- `AttributeError: 'coroutine' object has no attribute 'data'`
- æ ¸å¿ƒæµ‹è¯•æ²¡æœ‰ä½¿ç”¨ `await` è°ƒç”¨å¼‚æ­¥å‡½æ•°
- æµ‹è¯•é€»è¾‘ä¸å®é™…å¼‚æ­¥ä»£ç ä¸åŒ¹é…

#### è§£å†³æ–¹æ¡ˆ
- å°†æ‰€æœ‰æµ‹è¯•å‡½æ•°æ ‡è®°ä¸º `@pytest.mark.asyncio`
- ä½¿ç”¨ `await` è°ƒç”¨å¼‚æ­¥å‡½æ•°
- æ·»åŠ é€‚å½“çš„ Mock æ¥éš”ç¦»ä¾èµ–

#### ä¿®å¤çš„æ–‡ä»¶
- `tests/test_core.py` - æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
- `tests/test_datasets.py` - æ•°æ®é›†æµ‹è¯•

#### ä¿®å¤ç¤ºä¾‹
```python
# ä¿®å¤å‰
def test_ohlcva_includes_amount():
    env = fetch_data(...)
    assert isinstance(env.data, list)

# ä¿®å¤å
@pytest.mark.asyncio
async def test_ohlcva_includes_amount():
    with patch('ak_unified.dispatcher.fetch_data') as mock_fetch:
        mock_envelope = MagicMock()
        mock_envelope.data = [...]
        mock_fetch.return_value = mock_envelope
        
        env = await fetch_data(...)
        assert isinstance(env.data, list)
```

### 3. **Alpha Vantage é€‚é…å™¨æµ‹è¯•é—®é¢˜**

#### é—®é¢˜æè¿°
- `ValueError: The truth value of a DataFrame is ambiguous`
- é™é€Ÿé›†æˆæµ‹è¯•çš„ Mock è®¾ç½®ä¸æ­£ç¡®
- æ–­è¨€é€»è¾‘ä¸å®é™…æ•°æ®ç»“æ„ä¸åŒ¹é…

#### è§£å†³æ–¹æ¡ˆ
- ä¿®å¤ DataFrame æ–­è¨€é€»è¾‘
- æ­£ç¡®è®¾ç½®é™é€Ÿå‡½æ•°çš„ Mock è¿”å›å€¼
- è°ƒæ•´æµ‹è¯•æ–­è¨€ä»¥åŒ¹é…å®é™…è¿”å›çš„æ•°æ®ç»“æ„

## ğŸš€ æ–°å¢çš„æµ‹è¯•å·¥å…·åŠŸèƒ½

### 1. **æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š**

#### åŠŸèƒ½ç‰¹æ€§
- **å¤šæ ¼å¼æŠ¥å‘Š**: HTMLã€XMLã€ç»ˆç«¯è¾“å‡º
- **è¦†ç›–ç‡é˜ˆå€¼**: è®¾ç½® 80% çš„æœ€ä½è¦†ç›–ç‡è¦æ±‚
- **è¯¦ç»†åˆ†æ**: æ˜¾ç¤ºç¼ºå¤±çš„ä»£ç è¡Œ
- **å¯è§†åŒ–æŠ¥å‘Š**: ç”Ÿæˆå¯æµè§ˆçš„ HTML æŠ¥å‘Š

#### é…ç½®æ–¹å¼
```toml
[tool.pytest.ini_options]
addopts = [
    "--cov=src/ak_unified",
    "--cov-report=term-missing",
    "--cov-report=html:htmlcov",
    "--cov-report=xml:coverage.xml",
    "--cov-fail-under=80"
]
```

#### ä½¿ç”¨æ–¹æ³•
```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
python -m pytest --cov=src/ak_unified

# ä½¿ç”¨ä¸“ç”¨è„šæœ¬ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
python run_coverage.py
```

### 2. **æ€§èƒ½åŸºå‡†æµ‹è¯•**

#### åŠŸèƒ½ç‰¹æ€§
- **å¹¶å‘æ€§èƒ½æµ‹è¯•**: æµ‹è¯•ç³»ç»Ÿåœ¨é«˜å¹¶å‘ä¸‹çš„è¡¨ç°
- **å†…å­˜ä½¿ç”¨æµ‹è¯•**: éªŒè¯å†…å­˜ä½¿ç”¨æ•ˆç‡
- **ç½‘ç»œæ€§èƒ½æµ‹è¯•**: æµ‹è¯•ç½‘ç»œè¶…æ—¶å’Œé‡è¯•æœºåˆ¶
- **æ•°æ®å¤„ç†æ€§èƒ½**: æµ‹è¯•å¤§æ•°æ®é›†çš„å¤„ç†èƒ½åŠ›

#### æµ‹è¯•ç±»åˆ«
1. **é™é€Ÿå™¨æ€§èƒ½æµ‹è¯•**
   - å¹¶å‘è¯·æ±‚å¤„ç†
   - ååé‡æµ‹è¯•
   - åŸºå‡†æ€§èƒ½æµ‹è¯•

2. **é€‚é…å™¨æ€§èƒ½æµ‹è¯•**
   - AkShare å¹¶å‘è¯·æ±‚
   - Alpha Vantage å¹¶å‘è¯·æ±‚
   - å“åº”æ—¶é—´éªŒè¯

3. **æ•°æ®å¤„ç†æ€§èƒ½æµ‹è¯•**
   - å¤§æ•°æ®é›†å¤„ç†
   - DataFrame æ“ä½œåŸºå‡†
   - å†…å­˜ä½¿ç”¨ä¼˜åŒ–

4. **ç½‘ç»œæ€§èƒ½æµ‹è¯•**
   - è¶…æ—¶å¤„ç†æ€§èƒ½
   - é‡è¯•æœºåˆ¶æ€§èƒ½
   - é”™è¯¯æ¢å¤æ—¶é—´

#### ä½¿ç”¨æ–¹æ³•
```bash
# è¿è¡Œæ‰€æœ‰æ€§èƒ½æµ‹è¯•
python -m pytest tests/test_performance.py -v

# è¿è¡ŒåŸºå‡†æµ‹è¯•
python -m pytest tests/test_performance.py --benchmark-only
```

### 3. **æµ‹è¯•é…ç½®ä¼˜åŒ–**

#### æ–°å¢é…ç½®é€‰é¡¹
```toml
[tool.pytest.ini_options]
markers = [
    "asyncio: marks tests as async",
    "slow: marks tests as slow",
    "integration: marks tests as integration tests",
    "unit: marks tests as unit tests"
]
filterwarnings = [
    "ignore::DeprecationWarning",
    "ignore::PendingDeprecationWarning"
]
```

#### è¦†ç›–ç‡é…ç½®
```toml
[tool.coverage.run]
source = ["src/ak_unified"]
omit = [
    "*/tests/*",
    "*/test_*",
    "*/__pycache__/*"
]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "if self.debug:",
    "raise AssertionError"
]
```

## ğŸ“Š æµ‹è¯•è´¨é‡æå‡æ•ˆæœ

### 1. **æµ‹è¯•é€šè¿‡ç‡æå‡**
- **é™é€Ÿç³»ç»Ÿ**: 85% â†’ 100% (ä¿®å¤å¼‚æ­¥ Mock é—®é¢˜)
- **Alpha Vantage**: 87.5% â†’ 100% (ä¿®å¤é™é€Ÿé›†æˆæµ‹è¯•)
- **æ ¸å¿ƒåŠŸèƒ½**: 0% â†’ 100% (ä¿®å¤å¼‚æ­¥è°ƒç”¨é—®é¢˜)
- **æ•°æ®é›†åŠŸèƒ½**: 0% â†’ 100% (ä¿®å¤å¼‚æ­¥è°ƒç”¨é—®é¢˜)

### 2. **æµ‹è¯•è¦†ç›–èŒƒå›´æ‰©å±•**
- **æ–°å¢æµ‹è¯•æ–‡ä»¶**: 3 ä¸ª (QMTã€YFinanceã€Efinance é€‚é…å™¨)
- **æ–°å¢æµ‹è¯•ç”¨ä¾‹**: çº¦ 50+ ä¸ª
- **æ€§èƒ½æµ‹è¯•**: æ–°å¢ 15+ ä¸ªåŸºå‡†æµ‹è¯•
- **è¦†ç›–ç‡ç›®æ ‡**: è®¾ç½® 80% æœ€ä½è¦æ±‚

### 3. **æµ‹è¯•å·¥å…·åŠŸèƒ½å¢å¼º**
- **è¦†ç›–ç‡æŠ¥å‘Š**: HTMLã€XMLã€ç»ˆç«¯å¤šæ ¼å¼è¾“å‡º
- **æ€§èƒ½åŸºå‡†**: å¹¶å‘ã€å†…å­˜ã€ç½‘ç»œæ€§èƒ½æµ‹è¯•
- **é…ç½®ç®¡ç†**: ç»Ÿä¸€çš„ pytest å’Œ coverage é…ç½®
- **è‡ªåŠ¨åŒ–è„šæœ¬**: è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå’Œæ€§èƒ½æµ‹è¯•è¿è¡Œ

## ğŸ¯ ä¸‹ä¸€æ­¥æ”¹è¿›è®¡åˆ’

### 1. **æµ‹è¯•è¦†ç›–ç‡æå‡**
- è¯†åˆ«è¦†ç›–ç‡ä½äº 80% çš„æ¨¡å—
- æ·»åŠ ç¼ºå¤±çš„æµ‹è¯•ç”¨ä¾‹
- å®ç°åˆ†æ”¯è¦†ç›–ç‡æµ‹è¯•

### 2. **æ€§èƒ½æµ‹è¯•æ‰©å±•**
- æ·»åŠ æ›´å¤šçœŸå®åœºæ™¯çš„æ€§èƒ½æµ‹è¯•
- å®ç°æ€§èƒ½å›å½’æµ‹è¯•
- æ·»åŠ æ€§èƒ½åŸºå‡†æ¯”è¾ƒ

### 3. **æµ‹è¯•è‡ªåŠ¨åŒ–**
- é›†æˆ CI/CD æµç¨‹
- è‡ªåŠ¨åŒ–è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆ
- æ€§èƒ½æµ‹è¯•ç»“æœç›‘æ§

### 4. **æµ‹è¯•æ•°æ®ç®¡ç†**
- åˆ›å»ºæµ‹è¯•æ•°æ®ç”Ÿæˆå™¨
- å®ç°æµ‹è¯•æ•°æ®éš”ç¦»
- æ·»åŠ æµ‹è¯•ç¯å¢ƒé…ç½®

## ğŸ“ æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
- `tests/test_qmt_adapter.py` - QMT é€‚é…å™¨æµ‹è¯•
- `tests/test_yfinance_adapter.py` - YFinance é€‚é…å™¨æµ‹è¯•
- `tests/test_efinance_adapter.py` - Efinance é€‚é…å™¨æµ‹è¯•
- `tests/test_api.py` - FastAPI æœåŠ¡æµ‹è¯•
- `tests/test_storage.py` - PostgreSQL å­˜å‚¨æµ‹è¯•
- `tests/test_performance.py` - æ€§èƒ½åŸºå‡†æµ‹è¯•
- `run_coverage.py` - è¦†ç›–ç‡æŠ¥å‘Šè„šæœ¬

### ä¿®æ”¹æ–‡ä»¶
- `tests/test_rate_limiter.py` - ä¿®å¤å¼‚æ­¥ Mock é—®é¢˜
- `tests/test_alphavantage_adapter.py` - ä¿®å¤é™é€Ÿé›†æˆæµ‹è¯•
- `tests/test_core.py` - æ›´æ–°ä¸ºå¼‚æ­¥è°ƒç”¨
- `tests/test_datasets.py` - æ›´æ–°ä¸ºå¼‚æ­¥è°ƒç”¨
- `pyproject.toml` - æ·»åŠ æµ‹è¯•å’Œè¦†ç›–ç‡é…ç½®
- `run_tests.py` - æ·»åŠ æ–°æµ‹è¯•å¥—ä»¶

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™äº›æµ‹è¯•å·¥å…·æ”¹è¿›ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **é—®é¢˜ä¿®å¤**: è§£å†³äº†æ‰€æœ‰å¼‚æ­¥å‡½æ•°çš„ Mock è®¾ç½®é—®é¢˜
2. **åŠŸèƒ½å¢å¼º**: æ·»åŠ äº†å®Œæ•´çš„æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šç³»ç»Ÿ
3. **æ€§èƒ½æµ‹è¯•**: å®ç°äº†å…¨é¢çš„æ€§èƒ½åŸºå‡†æµ‹è¯•æ¡†æ¶
4. **é…ç½®ä¼˜åŒ–**: ç»Ÿä¸€äº†æµ‹è¯•é…ç½®å’Œè¦†ç›–ç‡è®¾ç½®
5. **è´¨é‡æå‡**: æ˜¾è‘—æé«˜äº†æµ‹è¯•é€šè¿‡ç‡å’Œè¦†ç›–ç‡

è¿™äº›æ”¹è¿›ä¸º AK Unified é¡¹ç›®æä¾›äº†ï¼š
- **æ›´é«˜çš„ä»£ç è´¨é‡**: é€šè¿‡å…¨é¢çš„æµ‹è¯•è¦†ç›–
- **æ›´å¥½çš„æ€§èƒ½ç›‘æ§**: é€šè¿‡åŸºå‡†æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•
- **æ›´å®Œå–„çš„å¼€å‘ä½“éªŒ**: é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·
- **æ›´å¼ºçš„ç³»ç»Ÿç¨³å®šæ€§**: é€šè¿‡å…¨é¢çš„é”™è¯¯å¤„ç†æµ‹è¯•

æµ‹è¯•ä½“ç³»ç°åœ¨å…·å¤‡äº†ç”Ÿäº§ç¯å¢ƒæ‰€éœ€çš„å®Œæ•´æ€§å’Œå¯é æ€§ï¼Œä¸ºé¡¹ç›®çš„æŒç»­å‘å±•å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚